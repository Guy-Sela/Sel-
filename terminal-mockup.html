<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Selà — Terminal Mockup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400&family=Josefin+Sans:wght@300;400&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: rgba(0, 0, 0, 0.45);
      --border: rgba(255, 255, 255, 0.12);
      --text: rgba(255, 255, 255, 0.92);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Josefin Sans', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .terminal {
      width: min(980px, 92vw);
      height: min(720px, 86vh);
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.6);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .terminal-body {
      width: 100%;
      max-width: 800px; /* Limit width for readability */
      padding: 40px;
      box-sizing: border-box;
      font-family: 'Roboto Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.01em;
      line-height: 1.7;
      text-align: left;
    }

    /* Terminal output (prompt + wrapped text) */
    .typedline {
      display: grid;
      grid-template-columns: 2ch minmax(0, 1fr);
      column-gap: 0;
      align-items: start;
      font-size: 1.1rem;
    }

    .prompt {
      color: rgba(255, 255, 255, 0.92);
      font-weight: bold;
      user-select: none;
    }

    .line {
      min-width: 0;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    /* 
       Cursor:
       User requested "_" style.
       We'll make it an underscore character look.
    */
    .cursor {
      display: inline;
      color: var(--text);
      font-weight: bold;
      opacity: 0.95;
      text-decoration: none;
      vertical-align: baseline;
    }

    .cursor.is-hidden {
      visibility: hidden;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .cursor.blink {
      animation: blink 1s infinite step-end;
    }

    .fake-tm {
      font-size: 0.72em;
      vertical-align: super;
      letter-spacing: 0.02em;
      opacity: 0.9;
      margin-left: 0.1ch;
    }
    
    .pop-num {
      /* Ensure numbers don't break in the middle */
      white-space: nowrap; 
    }

    @media (prefers-reduced-motion: reduce) {
      .cursor {
        animation: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="terminal" role="region" aria-label="Terminal mockup">
    <div class="terminal-body">
      <div id="typedLine" class="typedline" aria-label="Terminal output">
        <span class="prompt">❯</span>
        <span class="line"><span id="typedText"></span><span id="cursor" class="cursor">_</span></span>
      </div>
    </div>
  </div>

  <script>
    (function initTerminalMock() {
      const typedText = document.getElementById('typedText');
      const cursor = document.getElementById('cursor');
      if (!typedText || !cursor) return;

      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // --- UTILS ---
      function sleep(ms) {
        return new Promise(r => window.setTimeout(r, ms));
      }

      function setCursorVisible(v) {
        cursor.classList.toggle('is-hidden', !v);
      }

      function resetPrompt() {
        typedText.textContent = '';
        typedText.appendChild(cursor);
      }

      // --- WORLD POPULATION ---
      function initWorldPop() {
        const state = {
          text: '—',
          ready: false,
          readyPromise: null,
          _resolveReady: null,
          _pop: NaN,
          _rate: NaN,
          _timer: null,
          listeners: [], // array of callback functions
          start: () => { },
          stop: () => { },
          subscribe: (fn) => { state.listeners.push(fn); }
        };

        state.readyPromise = new Promise((resolve) => { state._resolveReady = resolve; });

        function markReady() {
          if (state.ready) return;
          state.ready = true;
          state._resolveReady?.();
          state._resolveReady = null;
        }

        function format(n) {
          return Number(n).toLocaleString('en-US');
        }

        state.start = () => {
          if (state._timer) return;
          if (!Number.isFinite(state._pop) || !Number.isFinite(state._rate)) return;
          
          // Tick every 100ms for smoother feeling if rate is high, 
          // but typically 1s is standard for population clocks. 
          // We'll stick to 1s to match "tick" feel.
          state._timer = window.setInterval(() => {
            state._pop += state._rate; // Add rate per second
            state.text = format(Math.floor(state._pop));
            state.listeners.forEach(fn => fn(state.text));
          }, 1000);
        };

        const url = `https://www.census.gov/popclock/data/population.php/world?_=${Date.now()}`;
        fetch(url, { cache: 'no-store' })
          .then(res => {
            if (!res.ok) throw new Error(`popclock HTTP ${res.status}`);
            return res.json();
          })
          .then(data => {
            state._pop = Number(data?.world?.population);
            state._rate = Number(data?.world?.population_rate);
            if (!Number.isFinite(state._pop) || !Number.isFinite(state._rate)) throw new Error('bad payload');
            state.text = format(Math.floor(state._pop));
            markReady();
          })
          .catch(() => {
            state.text = '8,000,000,000'; // Fallback
            markReady();
          });

        return state;
      }

      // --- TYPING ENGINE ---
      async function typeInto(container, text, opts = {}) {
        // 120 WPM ~ 600 CPM ~ 100ms/char
        // We'll vary slightly around 80-120ms to average ~100ms.
        const min = opts.minDelay ?? 70;
        const max = opts.maxDelay ?? 110;
        const pausePunct = opts.pausePunct ?? 300; // Stronger pauses for punctuation
        
        const jitter = () => Math.floor(min + Math.random() * (max - min));

        for (let i = 0; i < text.length; i++) {
          const ch = text[i];
          container.append(ch);
          // Move cursor to END of the container so it visually follows the new character
          // This ensures it wraps correctly with the text flow.
          container.appendChild(cursor);
          
          // Pause logic
          if (ch === '.' || ch === '!' || ch === '?') await sleep(pausePunct + 200);
          else if (ch === ',' || ch === ';' || ch === ':') await sleep(pausePunct);
          else await sleep(jitter());
        }
      }

      async function blink(times = 4) {
        cursor.classList.add('blink');
        setCursorVisible(true);
        await sleep(times * 600); // Slower blink
        cursor.classList.remove('blink');
        setCursorVisible(true); // Keep visible when active
      }

      // --- MAIN RUN ---
      async function run() {
        const wp = initWorldPop();

        // 1. Initial State
        resetPrompt();
        // Ensure cursor is visible
        setCursorVisible(true);
        cursor.classList.add('blink');
        
        // Wait a moment before starting
        await sleep(800);
        cursor.classList.remove('blink');

        // 2. Start Typing
        const speed120 = { minDelay: 60, maxDelay: 100, pausePunct: 250 };
        
        // Segment 1
        await typeInto(typedText, 'Born 1977, Israel.', speed120);
        await sleep(800);

        // Segment 2
        await typeInto(typedText, ' On a good day, one in ', speed120);
        
        // POPULATION 1
        const popSpan1 = document.createElement('span');
        popSpan1.className = 'pop-num';
        typedText.appendChild(popSpan1);
        
        // Wait for data
        await Promise.race([wp.readyPromise, sleep(2000)]);
        const initialVal = wp.text;
        
        // Type the initial number
        await typeInto(popSpan1, initialVal, { minDelay: 80, maxDelay: 120 });
        
        // Ensure cursor is at the very end after typing into a sub-span
        typedText.appendChild(cursor);

        // Register listener (sync) AFTER typing to avoid jump
        wp.subscribe((val) => { popSpan1.textContent = val; });
        
        // Start ticking immediately
        wp.start();

        // Continue typing immediately
        await typeInto(typedText, '.', speed120);

        await sleep(800);

        // Segment 3
        await typeInto(typedText, ' On a bad day, one of ', speed120);

        // POPULATION 2
        const popSpan2 = document.createElement('span');
        popSpan2.className = 'pop-num';
        typedText.appendChild(popSpan2);
        
        // Pause ticking while we type the second number so it cannot change mid-type (prevents "jump").
        wp.stop();

        // Get current (live) value to type
        const currentVal = wp.text; 
        await typeInto(popSpan2, currentVal, { minDelay: 80, maxDelay: 120 });
        
        // Ensure cursor is at the very end after typing into a sub-span
        typedText.appendChild(cursor);

        // Register listener (sync) AFTER typing
        wp.subscribe((val) => { popSpan2.textContent = val; });
        // Resume ticking after both counters are live
        wp.start();

        // Continue
        await typeInto(typedText, '.', speed120);

        await sleep(800);

        // Segment 4
        await typeInto(typedText, ' Code for consciousness', speed120);
        
        // TM
        const tm = document.createElement('span');
        tm.className = 'fake-tm';
        tm.textContent = 'TM';
        typedText.appendChild(tm);
        typedText.appendChild(cursor); // Keep cursor after TM
        
        // Final period
        await typeInto(typedText, '.', speed120);

        // Done
        cursor.classList.add('blink');
      }

      run().catch(console.error);
    })();
  </script>
</body>

</html>